# 要件定義書

## はじめに

Spreadsheet Sampleは、Webブラウザ上で動作する軽量なスプレッドシートアプリケーションです。ユーザーはグリッド状のセルに値や数式を入力でき、リアルタイムで計算結果が反映されます。本システムは計算ロジック（Spreadsheet Engine）とUIコンポーネントを明確に分離し、ロジック部分は徹底的なテストカバレッジを実現します。

## 用語集

- **システム**: Spreadsheet Sampleアプリケーション全体
- **エンジン**: UIに依存しない計算ロジック層（Spreadsheet Engine）
- **グリッド**: セルの集合体（10列 x 20行）
- **セル**: グリッド内の個別のデータ単位
- **数式**: `=`で始まる計算式
- **セル参照**: 他のセルを参照する識別子（例: A1, B2）
- **範囲**: 複数のセルを表す範囲指定（例: A1:A5）
- **依存関係グラフ**: セル間の参照関係を管理するデータ構造
- **編集モード**: セルの内容を編集できる状態
- **表示モード**: セルの計算結果を表示する状態

## 要件

### 要件1: グリッド表示

**ユーザーストーリー:** ユーザーとして、列と行のヘッダーを持つスプレッドシートグリッドを見たい。そうすることで、セルを簡単に識別してナビゲートできる。

#### 受入基準

1. THE システム SHALL 10列20行のグリッドを表示する
2. THE システム SHALL AからJまでラベル付けされた列ヘッダーを表示する
3. THE システム SHALL 1から20までラベル付けされた行ヘッダーを表示する
4. WHEN アプリケーションが読み込まれる THEN THE システム SHALL 完全なグリッド構造をレンダリングする

### 要件2: セル選択

**ユーザーストーリー:** ユーザーとして、マウスまたはキーボードを使用してセルを選択したい。そうすることで、スプレッドシートを効率的にナビゲートできる。

#### 受入基準

1. WHEN ユーザーがセルをクリックする THEN THE システム SHALL そのセルを選択状態としてハイライト表示する
2. WHEN ユーザーが矢印キーを押す THEN THE システム SHALL 選択を対応する方向の隣接セルに移動する
3. WHILE セルが選択されている THE システム SHALL 他のセルと区別する視覚的インジケーターを表示する
4. THE システム SHALL 常に正確に1つの選択されたセルを維持する

### 要件3: データ入力と編集

**ユーザーストーリー:** ユーザーとして、セルにデータを入力および編集したい。そうすることで、スプレッドシートのコンテンツを入力できる。

#### 受入基準

1. WHEN ユーザーがセルをダブルクリックする THEN THE システム SHALL そのセルの編集モードに入る
2. WHEN ユーザーが選択されたセルでEnterキーを押す THEN THE システム SHALL そのセルの編集モードに入る
3. WHILE 編集モード中 THE システム SHALL テキスト入力を許可する入力フィールドを表示する
4. WHEN ユーザーが編集モードでテキストまたは数値を入力する THEN THE システム SHALL その入力を受け入れる
5. WHEN ユーザーが編集モードでEnterキーを押すかセルの外側をクリックする THEN THE システム SHALL 入力を保存して表示モードに戻る
6. WHEN ユーザーが編集モードでEscapeキーを押す THEN THE システム SHALL 編集をキャンセルして保存せずに表示モードに戻る

### 要件4: 数式パーサー

**ユーザーストーリー:** ユーザーとして、`=`で始まる数式を入力したい。そうすることで、セルで計算を実行できる。

#### 受入基準

1. WHEN セルの値が`=`で始まる THEN THE エンジン SHALL それを数式として認識する
2. WHEN セルの値が`=`で始まらない THEN THE エンジン SHALL それをリテラルテキストまたは数値として扱う
3. THE エンジン SHALL 4つの算術演算子を含む数式を解析する: `+`, `-`, `*`, `/`
4. WHEN 数式に無効な構文が含まれている THEN THE エンジン SHALL `#ERR`エラーを返す

### 要件5: セル参照

**ユーザーストーリー:** ユーザーとして、数式内で他のセルを参照したい。そうすることで、動的な計算を作成できる。

#### 受入基準

1. WHEN 数式がセル参照を含む（例: `=A1`） THEN THE エンジン SHALL 参照されたセルから値を取得する
2. WHEN 数式が複数のセル参照を含む（例: `=A1+B2`） THEN THE エンジン SHALL すべての参照されたセルから値を取得する
3. WHEN 参照されたセルが空である THEN THE エンジン SHALL その値をゼロとして扱う
4. WHEN 参照されたセルがエラーを含む THEN THE エンジン SHALL そのエラーを参照元のセルに伝播する

### 要件6: 範囲指定と関数

**ユーザーストーリー:** ユーザーとして、セル範囲に対してSUMやAVGのような関数を使用したい。そうすることで、集計計算を効率的に実行できる。

#### 受入基準

1. THE エンジン SHALL `A1:B5`形式の範囲表記をサポートする
2. WHEN 数式が`SUM(範囲)`を含む THEN THE エンジン SHALL 指定された範囲内のすべての数値の合計を計算する
3. WHEN 数式が`AVG(範囲)`を含む THEN THE エンジン SHALL 指定された範囲内のすべての数値の平均を計算する
4. WHEN 範囲に非数値が含まれている THEN THE エンジン SHALL 計算でそれらを無視する
5. WHEN 範囲が無効である（例: グリッド境界外の`Z99:AA100`） THEN THE エンジン SHALL `#ERR`エラーを返す

### 要件7: 依存関係管理と再計算

**ユーザーストーリー:** ユーザーとして、依存関係が変更されたときにセルが自動的に再計算されることを望む。そうすることで、スプレッドシートを最新の状態に保つことができる。

#### 受入基準

1. WHEN セルの値が変更される THEN THE エンジン SHALL 依存関係グラフを使用してそれを参照するすべてのセルを識別する
2. WHEN セルの値が変更される THEN THE エンジン SHALL トポロジカル順序ですべての依存セルを再計算する
3. WHEN セルが更新される THEN THE システム SHALL 新しい計算値を即座にUIに反映する
4. THE エンジン SHALL すべてのセル参照関係を追跡する依存関係グラフを維持する

### 要件8: 循環参照検知

**ユーザーストーリー:** ユーザーとして、循環参照を作成したときに通知されることを望む。そうすることで、無効な数式を修正できる。

#### 受入基準

1. WHEN 数式が循環依存を作成する（例: A1がB1を参照し、B1がA1を参照する） THEN THE エンジン SHALL サイクルを検出する
2. WHEN 循環依存が検出される THEN THE エンジン SHALL サイクル内のすべてのセルに対して`#CYC`エラーを返す
3. THE エンジン SHALL 評価前にサイクルを検出することで、再計算中の無限ループを防止する

### 要件9: エラー処理

**ユーザーストーリー:** システムとして、エラーを適切に処理したい。そうすることで、無効な入力がアプリケーションをクラッシュさせないようにする。

#### 受入基準

1. WHEN 数式に構文エラーがある THEN THE エンジン SHALL `#ERR`エラーを返す
2. WHEN 循環参照が検出される THEN THE エンジン SHALL `#CYC`エラーを返す
3. WHEN 数式が無効なセルを参照する THEN THE エンジン SHALL `#ERR`エラーを返す
4. THE システム SHALL 他の機能を中断することなく、セルにエラー値を表示する

### 要件10: テスト可能性

**ユーザーストーリー:** 開発者として、エンジンを徹底的にテストしたい。そうすることで、正確性と保守性を確保できる。

#### 受入基準

1. THE エンジン SHALL UIから独立した純粋なTypeScript関数とクラスとして実装される
2. THE エンジン SHALL すべての計算ロジックをカバーする単体テストを持つ
3. THE エンジン SHALL 循環参照検出のテストを持つ
4. THE エンジン SHALL 連鎖的な再計算シナリオのテストを持つ
5. WHEN `npm run test`でテストが実行される THEN THE システム SHALL すべてのエンジンテストを実行して結果を報告する

### 要件11: 数式バー表示

**ユーザーストーリー:** ユーザーとして、現在選択されているセルの番地と入力内容を確認したい。そうすることで、数式の編集や確認が容易になる。

#### 受入基準

1. THE システム SHALL 数式バーを画面上部に表示する
2. WHEN セルが選択される THEN THE システム SHALL 数式バーに選択中のセル番地を表示する（例: A1, B5）
3. WHEN セルが選択される THEN THE システム SHALL 数式バーにそのセルの生の入力内容を表示する（数式の場合は`=`を含む完全な数式）
4. WHEN ユーザーが数式バーで内容を編集する THEN THE システム SHALL 選択中のセルの内容を更新する

### 要件12: セルの初期表示

**ユーザーストーリー:** ユーザーとして、値が入力されていないセルは空白で表示されることを望む。そうすることで、一般的なスプレッドシートアプリケーションと同じ使用感を得られる。

#### 受入基準

1. WHEN セルに値が入力されていない THEN THE システム SHALL そのセルを空白として表示する
2. WHEN 数式が空セルを参照する THEN THE エンジン SHALL その値を0として扱う（内部処理）
3. THE システム SHALL 空セルと値0を持つセルを視覚的に区別する（空セルは空白、値0のセルは"0"を表示）
